services:
  # ----------- Infra: Redis -----------
  redis:
    image: redis:7.4.5
    container_name: redis
    command: ["redis-server", "--appendonly", "yes"]
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - redis-data:/data
    networks: [danipa-net]
    restart: unless-stopped

  # ----------- Config Server -----------
  config-server:
    build:
      context: ./danipa-config-server
      dockerfile: Dockerfile
    container_name: danipa-config-server
    ports: ["8088:8088"]
    environment:
      SPRING_PROFILES_ACTIVE: native
      #SPRING_CONFIG_LOCATION: classpath:/
      CONFIG_USER: ${CONFIG_USER}
      CONFIG_PASS: ${CONFIG_PASS}
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: "file:/config-repo,file:/config-repo/danipa-fintech-service,file:/config-repo/danipa-stripe-service,file:/config-repo/danipa-paypal-service"

      # >>> Bus + Actuator exposure
      SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS: "kafka:9092"
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "health,info,env,refresh,busrefresh,configprops"

      LOG_DIR: /app/logs/danipa-config-server
    volumes:
      - ./config-repo:/config-repo:ro
      - ./logs/config:/app/logs/danipa-config-server
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "AUTH_OPT=\"\"; if [ -n \"$${CONFIG_USER}\" ] && [ -n \"$${CONFIG_PASS}\" ]; then AUTH_OPT=\"-u $${CONFIG_USER}:$${CONFIG_PASS}\"; fi; /usr/bin/curl -fsS -m 5 $${AUTH_OPT} http://127.0.0.1:8088/actuator/health >/dev/null"
        ]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 60s
    networks: [danipa-net]
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ----------- Eureka Server -----------
  eureka-server:
    build:
      context: ./danipa-eureka-server
      dockerfile: Dockerfile
    container_name: danipa-eureka-server
    ports: ["8761:8761"]
    environment:
      SPRING_PROFILES_ACTIVE: "${SPRING_PROFILES_ACTIVE:-dev}"
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8088"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://eureka-server:8761/eureka"
      JAVA_TOOL_OPTIONS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75"
      LOG_DIR: /app/logs/danipa-eureka-server
    volumes:
      - ./logs/eureka:/app/logs/danipa-eureka-server
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -m 3 http://127.0.0.1:8761/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 5s
      timeout: 5s
      retries: 24
      start_period: 60s
    networks: [danipa-net]
    depends_on:
      config-server:
        condition: service_healthy
    restart: unless-stopped

  # ----------- Fintech Service (MoMo) -----------
  fintech-service:
    build:
      context: ./danipa-fintech-service
      dockerfile: Dockerfile
    container_name: danipa-fintech-service
    ports: ["8080:8080"]
    environment:
      SPRING_PROFILES_ACTIVE: "${SPRING_PROFILES_ACTIVE:-dev}"
      # Config Server
      SPRING_CONFIG_IMPORT: "optional:configserver:"
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8088"
      SPRING_CLOUD_CONFIG_USERNAME: "${CONFIG_USER}"
      SPRING_CLOUD_CONFIG_PASSWORD: "${CONFIG_PASS}"
      SPRING_APPLICATION_NAME: "danipa-fintech-service"

      # Actuator
      ACTUATOR_USER: "${ACTUATOR_USER:-act}"
      ACTUATOR_PASS: "${ACTUATOR_PASS:-act-pass}"

      # Service discovery
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://eureka-server:8761/eureka"

      # Redis
      SPRING_DATA_REDIS_HOST: "redis"
      SPRING_DATA_REDIS_PORT: "6379"

      # Kafka
      SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS: "kafka:9092"
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "health,info,metrics,env,refresh,busrefresh,beans,configprops,prometheus"

      # Logging directory used by logback
      LOG_DIR: /app/logs/danipa-fintech-service

      # Logstash TCP destination (Logback â†’ Logstash)
      LOGGING_LOGSTASH_HOST: "logstash"
      LOGGING_LOGSTASH_PORT: "4560"

      # JVM
      JAVA_TOOL_OPTIONS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75"
    volumes:
      - ./logs/fintech:/app/logs/danipa-fintech-service
    healthcheck:
      test:
        [
          "CMD-SHELL",
          # 1) wait for the app to bind the port, then
          # 2) call readiness with basic auth and require HTTP 200
          "timeout 3 bash -lc '</dev/tcp/127.0.0.1/8080' \
               && [ \"$(curl -sS -u \"$${ACTUATOR_USER}:$${ACTUATOR_PASS}\" -o /dev/null -w \"%{http_code}\" http://127.0.0.1:8080/api/actuator/health/readiness)\" = 200 ]"
        ]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 60s
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
      config-server:
        condition: service_healthy
      logstash:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks: [danipa-net]
    restart: unless-stopped

  # ----------- Logstash -----------
  logstash:
    image: docker.elastic.co/logstash/logstash:8.14.2
    container_name: logstash
    expose: ["4560", "9600"]          # reachable on the bridge network
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./logstash/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
    environment:
      LS_JAVA_OPTS: "-Xms256m -Xmx256m"
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS -m 5 http://127.0.0.1:9600/_node | grep -Eq "\"status\":\"(green|yellow)\""' ]
      interval: 10s
      timeout: 5s
      retries: 12
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks: [danipa-net]
    restart: unless-stopped

  # ----------- Elasticsearch (single-node dev) -----------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.2
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false       # dev only (no auth)
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -m 5 http://127.0.0.1:9200/_cluster/health | grep -Eq '\"status\":\"(green|yellow)\"'"]
      interval: 10s
      timeout: 10s
      retries: 20
    networks: [danipa-net]
    restart: unless-stopped

  # ----------- Kibana -----------
  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.2
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    volumes:
      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks: [danipa-net]
    restart: unless-stopped

  # ----------- Kafka (single-node KRaft) -----------
  kafka:
    image: bitnami/kafka:3.6.2
    container_name: kafka
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_KRAFT_CLUSTER_ID=CDV_9wo0TrSIkeeg6AcOUQ     # any stable 22-char base64-ish id
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    ports:
      - "9092:9092"     # optional; needed only if you want host access
    volumes:
      - bus-kafka-data:/bitnami/kafka
    healthcheck:
      test: [ "CMD", "/opt/bitnami/kafka/bin/kafka-topics.sh", "--bootstrap-server=localhost:9092", "--list" ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 90s
    networks: [danipa-net]
    restart: unless-stopped
volumes:
  redis-data:
  es-data:
  bus-kafka-data:

networks:
  danipa-net:
    driver: bridge
