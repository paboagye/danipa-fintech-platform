input {
  tcp {
    id    => "json-over-tcp"
    host  => "0.0.0.0"
    port  => 4560
    mode  => "server"
    codec => json_lines
  }
}

filter {
  # Ensure a 'service' field exists (your apps should send it via Logback customFields)
  if ![service] or [service] == "" {
    mutate { add_field => { "service" => "unknown-service" } }
  }

  # Normalize timestamps:
  # - If @timestamp is a string (ISO8601), parse it.
  # - Else, if timeMillis exists (from some encoders), use UNIX_MS.
  if [@timestamp] and ([@timestamp] =~ "^[0-9]{4}-") {          # looks like ISO8601 string
    date {
      match  => ["@timestamp", "ISO8601"]
      target => "@timestamp"
    }
  } else if [timeMillis] {
    date {
      match  => ["timeMillis", "UNIX_MS"]
      target => "@timestamp"
    }
  }

  # Optional: add the running environment if your app sets it; default to 'dev'
  if ![env] or [env] == "" {
    mutate { add_field => { "env" => "dev" } }
  }

  # Optional cleanups to reduce noise
  mutate {
    # drop fields you don't care about; comment out if you want them
    remove_field => ["tags"]
  }
}

output {
  # Keep local visibility
  stdout {
    codec => rubydebug { metadata => true }
  }

  # Ship to Elasticsearch
  elasticsearch {
    hosts            => ["http://elasticsearch:9200"]
    index            => "danipa-%{[service]}-%{+YYYY.MM.dd}"
    ilm_enabled      => false           # simple daily indices for dev
    manage_template  => false
    timeout          => 30
  }
}
